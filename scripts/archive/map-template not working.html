---
layout: none
---

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>__TITLE__</title>
    <link rel="stylesheet" href="{{ site.baseurl }}/assets/lib/ol/ol.css">
    <script src="{{ site.baseurl }}/assets/lib/ol/ol.js"></script>


    <style>
        html, body { margin: 0; height: 100%; width: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; background-color: __BG__; }
        .ol-control { font-size: 17px; }
        .cross {
            top: 0.5em;
            left: 0.5em;
            float: right;
		}
        .cross button {
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cross button:hover,
        .cross button:focus {
            opacity: 1;
        }
        .cross button img {
            width: 13px;
            height: 13px;
            display: block;
            object-fit: contain;
        }
        .ol-zoom {
            top: 2.5em !important;  
        }
        .ol-control button {
            color: black !important;
        }
    </style>
</head>

<body>
    <div id="map" class="map"></div>
    <script>
        const width = __WIDTH__;
        const height = __HEIGHT__;
        const extent = [0, 0, width, height];

        // previous button with image
        const button = document.createElement("button");
        const img = document.createElement("img");
        img.src = "/assets/icons/previous.png";
        img.alt = "Previous";
        button.appendChild(img);


        {% assign cols = site.collections %}
        {% for col in cols %}
            {% assign docs = col.docs %}
            {% for doc in docs %}
                {% if doc.path == "__PATHMD__" %}
                    console.log("{{doc.path}}")
                    {% assign link = doc.url | prepend: site.baseurl %}
                {% endif %}
            {% endfor %}    
        {% endfor %}
        {% assign cols = site.collections %}

        const handle = function (e) {
            window.open("{{ link }}", "_self");
        };
        button.addEventListener("click", handle, false);
		
        const element = document.createElement("div");
		element.className = "cross ol-unselectable ol-control";
		element.appendChild(button);

		const OneControl = new ol.control.Control({
			element: element
		});

        // end cross button

        const projection = new ol.proj.Projection({
            code: "pixels",
            units: "pixels",
            extent: extent,
        });

        // Create custom tile grid with proper extent
        const tileGrid = new ol.tilegrid.TileGrid({
            extent: extent,
            resolutions: [8, 4, 2, 1, 0.5, 0.25], // Adjust based on your zoom levels
            tileSize: [256, 256]
        });

        // Custom tile URL function with bounds checking
        function getTileUrl(tileCoord) {
            const z = tileCoord[0];
            const x = tileCoord[1];
            const y = tileCoord[2];
            
            // Calculate tile extent for this coordinate
            const tileExtent = tileGrid.getTileCoordExtent(tileCoord);
            
            // Check if tile intersects with image extent
            if (!ol.extent.intersects(tileExtent, extent)) {
                return null; // Return null for tiles outside bounds
            }
            
            // Check if tile coordinates are within reasonable bounds
            const tileSize = 256;
            const resolution = tileGrid.getResolution(z);
            const maxTilesX = Math.ceil(width / (tileSize * resolution));
            const maxTilesY = Math.ceil(height / (tileSize * resolution));
            
            if (x < 0 || y < 0 || x >= maxTilesX || y >= maxTilesY) {
                return null;
            }
            
            return "{{ site.baseurl }}/assets/images/__IMG_NAME__/tiles/" + z + "/" + y + "/" + x + ".webp";
        }

        // Custom tile loading function with error handling
        function customTileLoadFunction(tile, src) {
            if (!src) {
                // If no source URL, mark as loaded with transparent tile
                tile.getImage().src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
                return;
            }
            
            const img = tile.getImage();
            img.onload = function() {
                // Tile loaded successfully
            };
            img.onerror = function() {
                // Handle error by showing transparent tile
                img.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
            };
            img.src = src;
        }

        const overlay = new ol.Overlay({
            element: document.createElement("div"),
        });

        const map = new ol.Map({
            layers: [
                new ol.layer.Tile({
                    preload: Infinity,
                    extent: extent,
                    source: new ol.source.TileImage({
                        tileGrid: tileGrid,
                        tileUrlFunction: getTileUrl,
                        tileLoadFunction: customTileLoadFunction,
                        projection: projection
                    })
                })
            ],
            overlays: [overlay],
            target: "map",
            view: new ol.View({
                projection: projection,
                center: ol.extent.getCenter(extent),
                zoom: 2,
                maxZoom: 6,
                extent: extent // Constrain view to extent
            }),
        });
        map.addControl(OneControl);
        
        // cursor
        map.getViewport().style.cursor = "-webkit-grab";
        map.on("pointerdrag", function (evt) {
            map.getViewport().style.cursor = "-webkit-grabbing";
        });

        map.on("pointerup", function (evt) {
            map.getViewport().style.cursor = "-webkit-grab";
        });
    </script>
</body>